name: "VULN-001: Timing side-channel leaks correct digits"
version: 1
vulnerability:
  type: timing-side-channel
  severity: high
  description: "The checkCombo() function adds a 50ms delay after each correct digit match before checking the next. This means a wrong guess on digit 1 returns in ~0ms, a correct digit 1 but wrong digit 2 returns in ~50ms, and all correct returns in ~150ms. An attacker can brute-force one digit at a time by measuring elapsed time."
  exploit: "An attacker tries all 10 values for digit 1 and measures the elapsed time printed in serial output. The value that produces ~50ms instead of ~0ms is correct (7). Repeat for digits 2 and 3. This reduces brute-force from 1000 combinations to 30."
  evidence: "When digit 1 is correct (7) but digit 2 is wrong, the elapsed time is ~50ms. When digit 1 is wrong, elapsed time is ~0ms. The difference proves the timing side-channel."
  line_numbers: [198, 200, 201, 203, 204]
steps:
  # Wait for boot
  - wait-serial: "=== COMBO SAFE v1.0 ==="
    timeout: 5000
  - delay: 1500

  # --- Attempt 1: Wrong first digit (0-0-0) → elapsed ~0ms ---
  - clear-serial: true
  # Digit 1 = 0 (default, just press)
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 100
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 500
  - wait-serial: "[input] Digit 1 = 0"
    timeout: 3000

  # Digit 2 = 0
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 100
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 500
  - wait-serial: "[input] Digit 2 = 0"
    timeout: 3000

  # Digit 3 = 0
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 100
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 500
  - wait-serial: "[check] WRONG combo - elapsed 0ms"
    timeout: 5000

  # Wait for reset after failed attempt
  - delay: 2000

  # --- Attempt 2: Correct first digit (7), wrong second (0-0) → elapsed ~50ms ---
  - clear-serial: true
  # Digit 1 = 7
  - set-control:
      part-id: encoder1
      control: rotate-cw
      value: 7
  - delay: 200
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 100
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 500
  - wait-serial: "[input] Digit 1 = 7"
    timeout: 3000

  # Digit 2 = 0
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 100
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 500
  - wait-serial: "[input] Digit 2 = 0"
    timeout: 3000

  # Digit 3 = 0
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 100
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 500
  # The elapsed time should be ~50ms, proving digit 1 was correct
  - wait-serial: "[check] WRONG combo - elapsed 50ms"
    timeout: 5000
  - expect-serial: "elapsed 50ms"
