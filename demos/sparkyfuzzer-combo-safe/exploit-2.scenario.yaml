name: "VULN-002: Timing Side-Channel in Combination Verification"
version: 1
vulnerability:
  type: timing-side-channel
  severity: high
  description: "The checkCombo() function on line 205 compares entered digits sequentially and adds a 50ms delay after each correct digit before checking the next. This creates a measurable timing difference: a wrong first digit returns in ~0ms, a correct first digit (but wrong second) returns in ~50ms, correct first two digits (wrong third) returns in ~100ms. An attacker can determine each digit independently by measuring response time."
  exploit: "An attacker enters combinations and measures the elapsed time reported in serial output. By trying digits 0-9 for the first position and looking for a ~50ms response (vs ~0ms), they identify the first digit. Repeating for positions 2 and 3 reduces the search space from 1000 to at most 30 attempts."
  evidence: "When the first digit is wrong (e.g., 0-0-0), elapsed time is ~0ms. When the first digit is correct (7) but second is wrong (e.g., 7-0-0), elapsed time is ~50ms. This ~50ms difference proves the timing side-channel."
  line_numbers: [205, 206, 207, 208, 209, 210, 211, 212, 213, 214, 215, 216, 217, 218, 219]
steps:
  # Wait for boot
  - delay: 500
  - wait-serial: "=== COMBO SAFE v1.0 ==="
    timeout: 3000
  # --- Attempt 1: Enter 0-0-0 (first digit WRONG) ---
  - clear-serial: true
  # Dial is already at 0, press to confirm digit 1 = 0
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 300
  # Confirm digit 2 = 0
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 300
  # Confirm digit 3 = 0 -> triggers check
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - wait-serial: "[check] WRONG combo"
    timeout: 5000
  # First digit wrong -> elapsed should be 0ms
  - expect-serial: "elapsed 0ms"
  # --- Wait for reset delay ---
  - delay: 2000
  # --- Attempt 2: Enter 7-0-0 (first digit CORRECT, second WRONG) ---
  - clear-serial: true
  # Rotate encoder to 7 for digit 1
  - set-control:
      part-id: encoder1
      control: rotate-cw
      value: 7
  - delay: 200
  # Press to confirm digit 1 = 7
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 300
  # Dial resets to 0, confirm digit 2 = 0
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 300
  # Confirm digit 3 = 0 -> triggers check
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - wait-serial: "[check] WRONG combo"
    timeout: 5000
  # First digit correct adds 50ms delay before failing on second digit
  - expect-serial: "elapsed 50ms"
